---
title: "order complexity"
author: "andrew richard"
output:
  html_document:
    toc: true
    code-fold: true
knitr: true
---


install libraries
```{r}
#| code-fold: true
shh <- suppressMessages
shh(library(DBI))
shh(library(RPostgres))
shh(library(tidyverse))
shh(library(lubridate))
shh(library(plotly))
shh(library(glue))
shh(library(DT))
```

set up connection to postgres
```{r}
#| code-fold: true
connection <- dbConnect(
  Postgres(),
  dbname = "metalworkingsolutions",
  host = "localhost",
  port = 5432,
  user = "postgres",
  password = "postgres"
  # password = rstudioapi::askForPassword("Database Password")
)
```

```{r}
#| code-fold: true
query <- "
SELECT
    omp_customer_organization_id,
    omp_sales_order_id,
    omp_customer_po,
    omp_order_date,
    uomp_promise_date,
    omp_payment_term_id,
    omp_order_total_base
FROM sales_orders;
"
result_set <- dbSendQuery(connection, query)
```

create tibble for customers
```{r}
#| code-fold: true
customers <- dbFetch(result_set)
dbClearResult(result_set)
```

## top 20 customers by revenue generated for 2023
```{r}
#| code-fold: true
top20_customers_2023 <- customers |>
  select(omp_order_date, omp_customer_organization_id, omp_order_total_base) |>
  group_by(omp_customer_organization_id) |>
  mutate(omp_order_date = year(omp_order_date)) |>
  filter(omp_order_date %in% 2023) |>
  summarise(generated_revenue_2023 = sum(omp_order_total_base)) |>
  rename(customer_id = omp_customer_organization_id) |>
  arrange(desc(generated_revenue_2023)) |>
  select(customer_id) |>
  head(20)
```

## top 20 customers by revenue generated for 2024
```{r}
#| code-fold: true
top20_customers_2024 <- customers |>
  select(omp_order_date, omp_customer_organization_id, omp_order_total_base) |>
  group_by(omp_customer_organization_id) |>
  mutate(omp_order_date = year(omp_order_date)) |>
  filter(omp_order_date %in% 2024) |>
  summarise(generated_revenue_2023 = sum(omp_order_total_base)) |>
  rename(customer_id = omp_customer_organization_id) |>
  arrange(desc(generated_revenue_2023)) |>
  select(customer_id) |>
  head(20)
```

## top 20 customers by revenue generated for 2023 & 2024
```{r}
#| code-fold: true
top20_customers_total <- customers |>
  select(omp_order_date, omp_customer_organization_id, omp_order_total_base) |>
  group_by(omp_customer_organization_id) |>
  mutate(omp_order_date = year(omp_order_date)) |>
  summarise(generated_revenue_2023 = sum(omp_order_total_base)) |>
  rename(customer_id = omp_customer_organization_id) |>
  arrange(desc(generated_revenue_2023)) |>
  select(customer_id) |>
  head(20)
```




```{r}
#| code-fold: true
query <- "
SELECT
    jmp_customer_organization_id AS customer_id,
    jmp_job_id AS job_id,
    jmp_part_id AS part_id,
    jmp_part_short_description AS part_description,
    jmp_order_quantity AS order_quantity,
    jmp_production_quantity AS production_quantity,
    jmp_production_due_date AS production_due_date

FROM jobs;
"
result_set <- dbSendQuery(connection, query)
jobs <- dbFetch(result_set)
dbClearResult(result_set)
```

## top 20 customers distinct number of jobs in jobs table
```{r}
#| code-fold: true
top_20_jobs <- jobs |>
  filter(customer_id %in% top20_customers_total$customer_id) |>
  group_by(customer_id) |>
  summarise(n_jobs = n_distinct(job_id)) |>
  arrange(desc(n_jobs))

p1 <- top_20_jobs |>
  ggplot(
    aes(
      x = fct_reorder(customer_id, -n_jobs),
      y = n_jobs,
      text = paste(
        "Customer ID: ", customer_id,
        "\nNumber of Jobs: ", n_jobs
      )
    )
  ) +
  geom_col(fill = "#445162", color = "#c61126", position = "dodge") +
  geom_text(
    aes(
      label = n_jobs,
      y = n_jobs + 100
    ), # Adjust the multiplier as needed
    color = "#445162",
    size = 3
  ) +
  labs(
    title = "Total Jobs by Customer ID",
    x = "Customer ID",
    Y = "Number of Jobs"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 55, hjust = 0.25)
  )

ggplotly(p1, tooltip = "text")
```


```{r}
big_spenders <- top20_customers_total$customer_id
```

## For our biggest spenders, who had the order with the most jobs?
```{r}
#| code-fold: true
complex_orders <- jobs |>
  filter(customer_id %in% big_spenders) |>
  mutate(order_id = str_sub(job_id, 1, 5)) |>
  group_by(customer_id, order_id) |>
  summarise(jobs_per_order = n_distinct(job_id), .groups = "drop") |>
  arrange(desc(jobs_per_order), customer_id)

# interactive visualization
# datatable(complex_orders)

#| code-fold: true
p2 <- complex_orders |>
  head(50) |>
  ggplot(
    aes(
      x = fct_reorder(order_id, -jobs_per_order),
      y = jobs_per_order,
      text = paste(
        "customer: ", customer_id,
        "\njobs/order: ", jobs_per_order
      )
    )
  ) +
  geom_col(fill = "#445162", color = "#c61126", position = "dodge") +
  geom_text(
    aes(
      label = jobs_per_order,
      y = jobs_per_order + 1
    ),
    color = "#445162",
    size = 2
  ) +
  labs(
    title = "Top 50 Sales orders by # jobs of Big Spenders",
    x = "Order ID",
    y = "Number of Jobs per Sales Order"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 65, hjust = 1)
  )

ggplotly(p2, tooltip = c("text"))
```


## For the biggest spenders, whose orders had the most jobs per order on average?
```{r}
#| code-fold: true
# jobs per sales order per customer
complex_orders <- jobs |>
  filter(customer_id %in% top20_customers_total$customer_id) |>
  mutate(order_id = str_sub(job_id, 1, 5)) |>
  group_by(customer_id, order_id) |>
  summarise(jobs_per_order = n_distinct(job_id), .groups = "drop") |>
  group_by(customer_id) |>
  summarise(avg_jobs_per_order = mean(jobs_per_order), .groups = "drop") |>
  arrange(desc(avg_jobs_per_order), customer_id)


p3 <- complex_orders |>
  ggplot(
    aes(
      x = fct_reorder(customer_id, -avg_jobs_per_order),
      y = avg_jobs_per_order,
      text = paste(
        "customer: ", customer_id,
        "\navg jobs/order: ", avg_jobs_per_order
      )
    )
  ) +
  geom_col(fill = "#445162", color = "#c61126") +
  geom_text(
    aes(
      label = round(avg_jobs_per_order, 1),
      y = round(avg_jobs_per_order, 1) - 0.25
    ),
    color = "#ffffff",
    size = 3.5
  ) +
  labs(
    title = "Average Jobs per Sales Order per Customer",
    x = "Customer",
    y = "Average Number of Jobs"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 55, hjust = 1)
  )

ggplotly(p3, tooltip = "text")
```


# Are there other customers who are creating more complex jobs than our top spenders?
```{r}
#| code-fold: true
top_20_total_jobs <- jobs |>
  mutate(order_id = str_sub(job_id, 1, 5)) |>
  group_by(order_id, customer_id) |>
  summarise(n_jobs = n_distinct(job_id), .groups = "drop") |>
  arrange(desc(n_jobs))


p4 <- top_20_total_jobs |>
  head(20) |>
  ggplot(
    aes(
      y = fct_reorder(order_id, n_jobs),
      x = n_jobs,
      text = paste(
        "Customer ID: ", customer_id,
        "\nNumber of Jobs: ", n_jobs
      )
    )
  ) +
  geom_bar(stat = "identity", fill = "#445162", color = "#c61126") +
  geom_text(
    aes(
      label = n_jobs,
      x = n_jobs - 2
    ),
    color = "#FFFFFF",
    size = 3.5,
    hjust = 1
  ) +
  geom_text(
    aes(
      label = customer_id,
      x = n_jobs / 2
    ),
    color = "#a1a7b0",
    size = 4,
    angle = 0,
    vjust = 0.5
  ) +
  labs(
    title = "Most jobs by sales order for all customers",
    y = "Sales Order ID",
    x = "Number of Jobs per order"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(angle = 0, hjust = 1) # Adjust to horizontal
  )

ggplotly(p4, tooltip = "text")
```



```{r}
n_jobs_per_order <- jobs |>
  mutate(order_id = str_sub(job_id, 1, 5)) |>
  group_by(order_id) |>
  summarize(n_jobs = n_distinct(job_id))


mean(n_jobs_per_order$n_jobs)
```
---
# TODO: 
- add color gradients to bar charts
- revenue per hour by customer? 
- ratio of jobs : order
- categorize orders by complexity and revenue generated
- define thresholds and decide which types of orders are most desireable
