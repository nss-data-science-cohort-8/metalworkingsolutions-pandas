---
title: "Using Postgre with R"
output: html_notebook
---

First, we need to establish a connection with our database. For this, we will use the RPostgres and DBI libraries.

If you are working with a large database, you might consider using the dbplyr library (https://dbplyr.tidyverse.org/articles/dbplyr.html), which allows you to use dplyr verbs to interact with tables in a database, but actually execute them in the database.

```{r}
library(DBI)
library(RPostgres)
library(tidyverse)
```


```{r}
con <- dbConnect(Postgres(),                 # Use the postgres driver
                 dbname = 'metalworking solution',     # Name of the database we want to connect to
                 host = 'localhost',         # 'localhost' or eg. 'ec2-54-83-201-96.compute-1.amazonaws.com'
                 port = 5432, 
                 user = 'postgres',
                 password = 'Postgre')


# SQL Query to Get New vs Existing Customers Per Month
query <- "
WITH first_transaction AS (
       SELECT 
        jmp_customer_organization_id,
        MIN(jmp_production_due_date) AS first_purchase_date
    FROM jobs
    GROUP BY jmp_customer_organization_id
)

SELECT 
    EXTRACT(YEAR FROM j.jmp_production_due_date) AS year,
    EXTRACT(MONTH FROM j.jmp_production_due_date) AS month,
    COUNT(DISTINCT CASE 
        WHEN f.first_purchase_date = j.jmp_production_due_date THEN j.jmp_customer_organization_id
    END) AS new_customers,
    COUNT(DISTINCT CASE 
        WHEN f.first_purchase_date < j.jmp_production_due_date THEN j.jmp_customer_organization_id
    END) AS existing_customers
FROM jobs AS j
JOIN first_transaction AS f 
    ON j.jmp_customer_organization_id = f.jmp_customer_organization_id
GROUP BY year, month
ORDER BY year, month;
"

customer_data <- dbGetQuery(con, query)

dbDisconnect(con)

customer_data <- customer_data %>%
  mutate(date = as.Date(paste(year, month, "01", sep = "-")))


customer_data_long <- customer_data %>%
  select(date, new_customers, existing_customers) %>%
  tidyr::pivot_longer(cols = c(new_customers, existing_customers), 
                      names_to = "customer_type", 
                      values_to = "count")


ggplot(customer_data_long, aes(x = date, y = count, fill = customer_type)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(title = "New vs Existing Customers Per Month",
       x = "Month",
       y = "Number of Customers",
       fill = "Customer Type") +
  theme_minimal() +
  scale_x_date(date_labels = "%b %Y", date_breaks = "1 month") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# Calculate percentages
customer_data_percent <- customer_data %>%
  mutate(total_customers = new_customers + existing_customers,
         new_customers_pct = (new_customers / total_customers) * 100,
         existing_customers_pct = (existing_customers / total_customers) * 100,
         date = as.Date(paste(year, month, "01", sep = "-"))) %>%
  select(date, new_customers_pct, existing_customers_pct)

# Pivot data to longer format for ggplot
customer_data_percent_long <- customer_data_percent %>%
  tidyr::pivot_longer(cols = c(new_customers_pct, existing_customers_pct),
                      names_to = "customer_type",
                      values_to = "percentage")

# Plot percentage stacked bar chart
ggplot(customer_data_percent_long, aes(x = date, y = percentage, fill = customer_type)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(title = "Percentage of New vs Existing Customers per Month",
       x = "Month-Year",
       y = "Percentage (%)",
       fill = "Customer Type") +
 theme_minimal() +
  scale_fill_manual(labels = c("Existing Customers", "New Customers"),
                    values = c("#445162", "#C61126")) +
  scale_x_date(date_labels = "%b %Y", date_breaks = "1 month") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 11),
        legend.text = element_text(size = 14),
        axis.title = element_text(size = 16))
   


```
```{r}
library(DBI)
library(RPostgres)
library(tidyverse)
con <- dbConnect(Postgres(),                 
                 dbname = 'metalworking solution',    
                 host = 'localhost',         
                 port = 5432, 
                 user = 'postgres',
                 password = 'Postgre')


query <- "
WITH first_transaction AS (
    SELECT 
        omp_customer_organization_id,
        MIN(omp_order_date) AS first_purchase_date
    FROM sales_orders
    GROUP BY omp_customer_organization_id
)

SELECT DISTINCT ON (o.omp_customer_organization_id)
    EXTRACT(YEAR FROM o.omp_order_date) AS year,
    EXTRACT(MONTH FROM o.omp_order_date) AS month,
    COUNT(DISTINCT CASE 
        WHEN DATE_TRUNC('month', f.first_purchase_date) = DATE_TRUNC('month', o.omp_order_date) 
        THEN o.omp_customer_organization_id
    END) AS new_customers,
    COUNT(DISTINCT CASE 
        WHEN DATE_TRUNC('month', f.first_purchase_date) < DATE_TRUNC('month', o.omp_order_date) 
        THEN o.omp_customer_organization_id
    END) AS existing_customers,
	COUNT(DISTINCT o.omp_customer_organization_id) AS total_no
FROM sales_orders AS o
JOIN first_transaction AS f 
    ON o.omp_customer_organization_id = f.omp_customer_organization_id
GROUP BY o.omp_customer_organization_id, year, month
ORDER BY o.omp_customer_organization_id,year, month;

"

customer_data <- dbGetQuery(con, query)

dbDisconnect(con)

customer_data <- customer_data %>%
  mutate(date = as.Date(paste(year, month, "01", sep = "-")))


customer_data_long <- customer_data %>%
  select(date, new_customers, existing_customers) %>%
  tidyr::pivot_longer(cols = c(new_customers, existing_customers), 
                      names_to = "customer_type", 
                      values_to = "count")



# Pivot data to longer format for ggplot
customer_data_percent_long <- customer_data_percent %>%
  tidyr::pivot_longer(cols = c(new_customers_pct, existing_customers_pct),
                      names_to = "customer_type",
                      values_to = "percentage")

# Plot percentage stacked bar chart
ggplot(customer_data_percent_long, aes(x = date, y = percentage, fill = customer_type)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(title = "Percentage of New vs Existing Customers per Month",
       x = "Month-Year",
       y = "Percentage (%)",
       fill = "Customer Type") +
 theme_minimal() +
  scale_fill_manual(labels = c("Existing Customers", "New Customers"),
                    values = c("#445162", "#C61126")) +
  scale_x_date(date_labels = "%b %Y", date_breaks = "1 month") +
  scale_y_continuous(labels = scales::percent_format(scale = 1), breaks = seq(0, 100, 10)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 11),
        legend.text = element_text(size = 14),
        axis.title = element_text(size = 15))

```
```{r}
# Load required libraries
library(DBI)
library(RPostgres)
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(bit64)
library(plotly)
library(acepack)

# Establish database connection
con <- dbConnect(RPostgres::Postgres(),
                 dbname = 'metalworking solution',
                 host = 'localhost',
                 port = 5432, 
                 user = 'postgres',
                 password = 'Postgre')

# Execute SQL query to get data
data <- dbGetQuery(con, "
SELECT  
    EXTRACT(YEAR FROM omp_order_date) AS year,
    EXTRACT(MONTH FROM omp_order_date) AS month, 
    omp_customer_organization_id, 
    COUNT(omp_sales_order_id) AS NoOfOrder 
FROM sales_orders
GROUP BY year, month, omp_customer_organization_id
ORDER BY year, month;
")

# Close the database connection
dbDisconnect(con)

# Explicitly convert integer64 to numeric
data$NoOfOrder <- as.numeric(data$nooforder)

# Add order date
data <- data %>%
  mutate(order_date = as.Date(paste(year, month, "01", sep="-")))

# Determine the cohort (first purchase month) for each customer
customer_cohort <- data %>%
  group_by(omp_customer_organization_id) %>%
  summarise(cohort_month = min(order_date))

# Merge cohort info back with original data
data <- data %>%
  left_join(customer_cohort, by = "omp_customer_organization_id")

# Calculate months since first purchase for each record
data <- data %>%
  mutate(months_since_first_order = interval(cohort_month, order_date) %/% months(1))
customer_cohort_summary <- data %>%
  group_by(omp_customer_organization_id, cohort_month, months_since_first_order) %>%
  summarise(total_orders = sum(nooforder), .groups='drop')

# Aggregate and arrange customers by the highest month since first order
customer_cohort_summary <- data %>%
  group_by(omp_customer_organization_id, cohort_month, months_since_first_order) %>%
  summarise(total_orders = sum(NoOfOrder), .groups='drop') %>%
  arrange(desc(months_since_first_order), omp_customer_organization_id) %>%
  mutate(customer_index = as.numeric(factor(omp_customer_organization_id, levels = unique(omp_customer_organization_id))))

# Plot interactive heatmap with numeric customer index and clear contrast colors
p_customer <- ggplot(customer_cohort_summary, aes(
          x = months_since_first_order, 
          y = customer_index, 
          fill = total_orders,
          text = paste("Customer Org ID:", omp_customer_organization_id,
                       "<br>Cohort Month:", cohort_month,
                       "<br>Months Since First Order:", months_since_first_order,
                       "<br>Total Orders:", total_orders))) +
  geom_tile(color = "gray80") +
  scale_fill_distiller(palette = "RdYlBu", direction = -1) +
  labs(title = "Customer-Level Cohort Analysis",
       x = "Months Since First Order",
       y = "Customer",
       fill = "Number of Orders") +
  theme_minimal() +
  theme(axis.text.y = element_text(size=7), 
        axis.ticks.y = element_line(size=0.2),
        panel.grid = element_blank())

# Interactive plot with improved contrast and numeric axis labels
ggplotly(p_customer, tooltip = "text")

last_months_since_first_order <- customer_cohort_summary %>%
  group_by(omp_customer_organization_id) %>%
  summarise(last_month_since_first_order = max(months_since_first_order), .groups = "drop")

customer_plot_order <- customer_cohort_summary %>%
  select(omp_customer_organization_id, customer_index) %>%
  distinct() %>%
  left_join(company_info, by = "omp_customer_organization_id") %>%
  arrange(desc(customer_index)) 
```
```{r}
library(DBI)
library(RPostgres)
library(ggplot2)
library(dplyr)
library(treemapify)

# Connect to PostgreSQL Database
con <- dbConnect(RPostgres::Postgres(),
                 dbname = "metalworking solution",
                 host = 'localhost',
                 port = 5432, 
                 user = 'postgres',
                 password = 'Postgre')

# SQL Query to Get Orders Per Part Type
query <- "
SELECT  
    s.omp_customer_organization_id AS customer_name,
    COUNT(DISTINCT s.omp_sales_order_id) AS NoOfOrder, 
    j.jmp_part_short_description AS part_type
FROM sales_orders AS s
INNER JOIN jobs AS j ON s.omp_customer_organization_id = j.jmp_customer_organization_id
GROUP BY s.omp_customer_organization_id, j.jmp_part_short_description
HAVING COUNT(DISTINCT s.omp_sales_order_id) = 1
ORDER BY s.omp_customer_organization_id;
"

# Fetch Data from Database
customer_data <- dbGetQuery(con, query)

# Disconnect from Database
dbDisconnect(con)

# Convert to Numeric if Necessary
customer_data_summary <- customer_data %>%
  group_by(part_type) %>%
  summarise(total_nooforder = sum(nooforder, na.rm = TRUE), .groups = "drop")

# Plot aggregated data
ggplot(customer_data_summary, aes(x = reorder(part_type, total_nooforder), y = total_nooforder, fill = total_nooforder)) +
  geom_bar(stat = "identity") +
  labs(title = "Part Types Ordered by One-Time Customers",
       x = "Part Type",
       y = "Number of Orders",
       fill = "Number of Orders") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8),  # Reduce x-axis tick font size
        legend.text = element_text(size = 8),  # Reduce legend font size
        legend.title = element_text(size = 10)) +  # Adjust legend title size if necessary
  scale_fill_gradient(low = "#445162", high = "black")  



ggplot(customer_data_summary, aes(area = total_nooforder, fill = part_type, label = part_type)) +
  geom_treemap() +
  geom_treemap_text(fontface = "bold", colour = "white", place = "centre", grow = TRUE) +
  scale_fill_viridis_d() +
  labs(title = "Parts Ordered by One-Time Customers") +
  theme_minimal()

```

```{r}
library(DBI)
library(RPostgres)
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(bit64)
library(plotly)
con <- dbConnect(Postgres(),                 
                 dbname = 'metalworking solution',    
                 host = 'localhost',         
                 port = 5432, 
                 user = 'postgres',
                 password = 'Postgre')


# SQL Query to Get New vs Existing Customers Per Month
query <- "

WITH first_transaction AS (
    SELECT 
        omp_customer_organization_id,
        MIN(omp_order_date) AS first_purchase_date
    FROM sales_orders
    GROUP BY omp_customer_organization_id
)

SELECT 
    EXTRACT(YEAR FROM o.omp_order_date) AS year,
    EXTRACT(MONTH FROM o.omp_order_date) AS month,

    -- Count distinct new customers per month
    COUNT(DISTINCT CASE 
        WHEN DATE_TRUNC('month', f.first_purchase_date) = DATE_TRUNC('month', o.omp_order_date) 
        THEN o.omp_customer_organization_id
    END) AS new_customers,

    -- Count distinct existing customers per month
    COUNT(DISTINCT CASE 
        WHEN DATE_TRUNC('month', f.first_purchase_date) < DATE_TRUNC('month', o.omp_order_date) 
        THEN o.omp_customer_organization_id
    END) AS existing_customers,

    -- Total distinct customers per month
    COUNT(DISTINCT o.omp_customer_organization_id) AS total_customers,

    -- Count total revenue from new customers
    SUM(CASE 
        WHEN DATE_TRUNC('month', f.first_purchase_date) = DATE_TRUNC('month', o.omp_order_date) 
        THEN o.omp_order_total_base
    END) AS total_order_new,

    -- Count total revenue from existing customers
    SUM(CASE 
        WHEN DATE_TRUNC('month', f.first_purchase_date) < DATE_TRUNC('month', o.omp_order_date) 
        THEN o.omp_order_total_base
    END) AS Total_orders_existing,

    -- Total revenue of orders per month
    SUM(o.omp_order_total_base) AS total_orders

FROM sales_orders AS o
INNER JOIN first_transaction AS f 
    ON o.omp_customer_organization_id = f.omp_customer_organization_id

GROUP BY year, month
ORDER BY year, month;



"

customer_data <- dbGetQuery(con, query)

dbDisconnect(con)

customer_data <- customer_data %>%
  mutate(date = as.Date(paste(year, month, "01", sep = "-")))


customer_data_long <- customer_data %>%
  select(date, new_customers, existing_customers) %>%
  tidyr::pivot_longer(cols = c(new_customers, existing_customers), 
                      names_to = "customer_type", 
                      values_to = "count")


ggplot(customer_data_long, aes(x = date, y = count, fill = customer_type)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(title = "New vs Existing Customers Per Month",
       x = "Month",
       y = "Number of Customers",
       fill = "Customer Type") +
  theme_minimal() +
  scale_x_date(date_labels = "%b %Y", date_breaks = "1 month") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# Calculate percentages
customer_data_percent <- customer_data %>%
  mutate(total_customers = new_customers + existing_customers,
         new_customers_pct = (new_customers / total_customers) * 100,
         existing_customers_pct = (existing_customers / total_customers) * 100,
         date = as.Date(paste(year, month, "01", sep = "-"))) %>%
  select(date, new_customers_pct, existing_customers_pct)

# Pivot data to longer format for ggplot
customer_data_percent_long <- customer_data_percent %>%
  tidyr::pivot_longer(cols = c(new_customers_pct, existing_customers_pct),
                      names_to = "customer_type",
                      values_to = "percentage")

# Plot percentage stacked bar chart
ggplot(customer_data_percent_long, aes(x = date, y = percentage, fill = customer_type)) + 
  geom_bar(stat = "identity", position = "stack") +
  labs(title = "Percentage of Total order from New vs Existing Customers per Month",
       x = "Month-Year",
       y = "Percentage (%)",
       fill = "Customer Type") +
 theme_minimal() +
  scale_fill_manual(labels = c("Existing Customers", "New Customers"),
                    values = c("#445162", "#C61126")) +
  scale_x_date(date_labels = "%b %Y", date_breaks = "1 month") +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
        axis.text.y = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.title = element_text(size = 16))
```



```{r}
library(DBI)
library(RPostgres)
library(dplyr)
library(ggplot2)
library(forcats)  # Use forcats for correct ordering

# Connect to PostgreSQL database
con <- dbConnect(Postgres(),
                 dbname = 'metalworking solution',
                 host = 'localhost',
                 port = 5432,
                 user = 'postgres',
                 password = 'Postgre')

# Execute SQL query and fetch results into a dataframe
df <- dbGetQuery(con, "
WITH first_transaction AS (
    SELECT 
        omp_customer_organization_id,
        MIN(omp_order_date) AS first_purchase_date
    FROM sales_orders
    GROUP BY omp_customer_organization_id
)

SELECT 
    o.omp_customer_organization_id,
    o.omp_order_date,
    DATE_TRUNC('month', o.omp_order_date) AS order_month,
    EXTRACT(YEAR FROM o.omp_order_date) AS order_year, 
    CASE 
        WHEN DATE_TRUNC('month', f.first_purchase_date) = DATE_TRUNC('month', o.omp_order_date)
        THEN 'New'
        ELSE 'Existing'
    END AS customer_type,
    j.jmp_part_short_description AS part_type,
    COUNT(j.jmp_part_short_description) AS no_ordered_part
FROM sales_orders AS o
INNER JOIN first_transaction AS f
    ON o.omp_customer_organization_id = f.omp_customer_organization_id
INNER JOIN jobs AS j
    ON j.jmp_customer_organization_id = o.omp_customer_organization_id
WHERE EXTRACT(YEAR FROM o.omp_order_date) IN (2023, 2024) 
AND CASE 
        WHEN DATE_TRUNC('month', f.first_purchase_date) = DATE_TRUNC('month', o.omp_order_date)
        THEN 'New'
        ELSE 'Existing'
    END = 'Existing'
GROUP BY 
    o.omp_customer_organization_id,
    o.omp_order_date,
    order_month,
    order_year,
    customer_type,
    j.jmp_part_short_description
ORDER BY order_year, no_ordered_part DESC;")

# Disconnect from the database
dbDisconnect(con)


df$order_year <- as.factor(df$order_year)

# Summarize total orders per part per year
parts_summary <- df %>%
  group_by(part_type) %>%
  summarise(total_ordered = sum(no_ordered_part), .groups = "drop")

# Get top 10 parts for each year separately
top_parts <- parts_summary %>%
  slice_max(order_by = total_ordered, n = 10) %>%
  ungroup()


top_parts <- top_parts %>%
  mutate(part_type = fct_reorder(part_type, total_ordered))

# Plot bar chart with **SEPARATE X-AXIS SCALES**
ggplot(top_parts, aes(x = part_type, y = total_ordered, fill = total_ordered)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  labs(title = "Top 10 Ordered Parts by Existing Customers",
       x = "Part Type",
       y = "Number Ordered") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 9),
        plot.title = element_text(size = 14, face = "bold"),
        axis.text.x = element_text(size = 10),
        strip.text = element_text(size = 12, face = "bold")) +
  scale_fill_gradient(low = "#AED6F1", high = "#1B4F72")
```



```{r}
library(plotly)

# Data for Pie Chart
df_total <- data.frame(
  customer_type = c("One-Time Buyer", "Repeated Customer"),
  count = c(25, 98)
)

# Create pie chart using plotly with custom colors
fig <- plot_ly(df_total, labels = ~customer_type, values = ~count, type = 'pie',
               textinfo = 'label+percent', insidetextorientation = 'radial',
               marker = list(colors = c("#C61126", "#445162"))) %>%
  layout(title = "Proportion of One-Time Buyers vs Repeated Customers")

# Display the plot
fig


```
```{r}

library(dplyr) 
library(readxl)
library(ggplot2)
library(tidyr)
library(scales)  

file_path <- "C:/Users/vetdd/Documents/NSS_project/metalworkingsolutions-pandas/25_03_11/company_per_month.xlsx"


df <- read_excel(file_path)


df$year_month <- as.Date(df$year_month)

df <- df %>%
  mutate(total_customers = new_companies + existing)


df_long <- df %>%
  pivot_longer(cols = c(new_companies, existing), names_to = "company_type", values_to = "count") %>%
  mutate(percentage = (count / total_customers))  # Convert to proportion (0-1)


p <- ggplot(df_long, aes(x = year_month, y = percentage, fill = company_type)) +
  geom_bar(stat = "identity", position = "fill") +  # Normalize bars to 100%
  scale_y_continuous(labels = percent_format(accuracy = 1)) +  # Convert 0-1 scale to 0%-100%
  labs(title = "Percentage of New vs Existing Companies Per Month",
       x = "Month",
       y = "Percentage of Companies",
       fill = "Company Type") +
  scale_fill_manual(values = c("new_companies" = "#C61126", "existing" = "#445162")) +  # Custom colors
  scale_x_date(date_labels = "%Y-%m", date_breaks = "2 months") +  
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


print(p)





```


```{r}
# One-time customer, ordered products
library(dplyr)
library(ggplot2)
library(readxl)

# Define the file path (update if needed)
file_path <- "C:/Users/vetdd/Documents/NSS_project/metalworkingsolutions-pandas/25_03_11/one_time_buyer_name_what_they_order.xlsx"

# Read the Excel file
df <- read_excel(file_path)

# Count occurrences of each product
top_products <- df %>%
  count(jmp_part_short_description, sort = TRUE) %>%  # Count and sort by frequency
  top_n(25, n)  # Select top 10 most ordered products

# Create a bar chart
p <- ggplot(top_products, aes(x = reorder(jmp_part_short_description, n), y = n)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(title = "Top 10 Most Ordered Products by One-time customers",
       x = "Product",
       y = "Number of Orders") +
  theme_minimal() +
  coord_flip()  # Flip for better readability

# Show plot
print(p)

```

```{r}
##New customer most ordered itemes in 2023 and 2024
library(dplyr)
library(ggplot2)
library(readxl)
library(lubridate)  

file_path <- "C:/Users/vetdd/Documents/NSS_project/metalworkingsolutions-pandas/25_03_11/first_time_buyer_ordered_items.xlsx"


df <- read_excel(file_path)


df$omp_order_date <- as.Date(df$omp_order_date, format = "%m/%d/%Y")


df$year <- year(df$omp_order_date)


get_top_products <- function(data, year_filter) {
  data %>%
    filter(year == year_filter) %>%
    count(jmp_part_short_description, sort = TRUE) %>%
    top_n(10, n)
}


top_products_2023 <- get_top_products(df, 2023)


top_products_2024 <- get_top_products(df, 2024)

# Create a bar chart for 2023
p1 <- ggplot(top_products_2023, aes(x = reorder(jmp_part_short_description, n), y = n)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(title = "Top 10 Most Ordered Products by First-Time Customers (2023)",
       x = "Product",
       y = "Number of Orders") +
  theme_minimal() +
  coord_flip()

# Create a bar chart for 2024
p2 <- ggplot(top_products_2024, aes(x = reorder(jmp_part_short_description, n), y = n)) +
  geom_bar(stat = "identity", fill = "darkred") +
  labs(title = "Top 10 Most Ordered Products by First-Time Customers (2024)",
       x = "Product",
       y = "Number of Orders") +
  theme_minimal() +
  coord_flip()

# Show both plots
print(p1)
print(p2)

```




```{r}
# Load necessary libraries
library(dplyr)
library(ggplot2)
library(readxl)
library(lubridate)

# Define the file path
file_path <- "C:/Users/vetdd/Documents/NSS_project/metalworkingsolutions-pandas/25_03_11/first_time_buyer_ordered_items.xlsx"

# Read the Excel file
df <- read_excel(file_path)

# Convert order date to Date format
df$omp_order_date <- as.Date(df$omp_order_date, format = "%m/%d/%Y")

# Identify the first order date for each customer
first_time_customers <- df %>%
  group_by(omp_customer_organization_id) %>%
  summarise(first_purchase_date = min(omp_order_date)) %>%
  ungroup()

# Extract year-month and count distinct customers per month
customers_per_month <- first_time_customers %>%
  mutate(year_month = floor_date(first_purchase_date, "month")) %>%  # Convert to year-month
  group_by(year_month) %>%
  summarise(num_customers = n()) %>%
  arrange(year_month)

# Calculate total number of first-time customers
total_customers <- sum(customers_per_month$num_customers)

# Create categorical variable for legend
customers_per_month$Legend <- "First-Time Customers"

# Create a bar chart showing distinct customers per month with labels
p <- ggplot(customers_per_month, aes(x = year_month, y = num_customers, fill = Legend)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = num_customers), vjust = -0.5, size = 4, fontface = "bold") +  # Add labels on bars
  scale_fill_manual(values = c("First-Time Customers" = "steelblue")) +  # Legend Color
  labs(title = paste("Number of First-Time Customers Per Month (Total:", total_customers, ")"),
       x = "Month",
       y = "Number of First-Time Customers",
       fill = "Customer Type") +  # Legend Title
  theme_minimal() +
  scale_x_date(date_labels = "%Y-%m", date_breaks = "2 months") +  # Show every 2 months
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

# Show plot
print(p)

# Print the summarized table
print(customers_per_month)




```
```{r}

library(dplyr)
library(ggplot2)
library(readxl)
library(lubridate)

file_path <- "C:/Users/vetdd/Documents/NSS_project/metalworkingsolutions-pandas/25_03_11/customer_hour_earned_2023.xlsx"

df <- read_excel(file_path)

df <- df %>%
  mutate(date = as.Date(paste(year, month, "01", sep = "-"), format = "%Y-%m-%d"))


selected_companies <- c("M030-MORGO", "Y002-YNGTC", "F022-F&D", "S038-STLKI",
                        "S039-SMI", "S002-SREIL", "M026-MIURA", "S046-SPOC",
                        "B035-BAC", "S025-SAKAI")

df_filtered <- df %>%
  filter(customer %in% selected_companies)


scale_factor <- max(df_filtered$total_earned, na.rm = TRUE) / max(df_filtered$time_in_hr, na.rm = TRUE)

# Create a dual-axis line chart
p <- ggplot(df_filtered, aes(x = date)) +
  geom_line(aes(y = total_earned, color = "Total Earned ($)"), size = 1) +  # Right Y-axis
  geom_line(aes(y = time_in_hr * scale_factor, color = "Time in Hours"), size = 1, linetype = "dashed") +  # Left Y-axis scaled
  scale_y_continuous(
    name = "Total Earned ($)",
    sec.axis = sec_axis(~ . / scale_factor, name = "Time in Hours")  # Fixing secondary axis
  ) +
  labs(title = "Total Earned vs. Time Spent (Selected Companies)",
       x = "Month/Year",
       color = "Metric") +
  scale_color_manual(values = c("Total Earned ($)" = "blue", "Time in Hours" = "red")) +
  scale_x_date(date_labels = "%Y-%m", date_breaks = "2 months") +  
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Show plot
print(p)

```
```{r}
library(dplyr)
library(ggplot2)
library(readxl)
library(lubridate)
library(scales)  

file_path <- "C:/Users/vetdd/Documents/NSS_project/metalworkingsolutions-pandas/25_03_11/customer_hour_earned.xlsx"
df <- read_excel(file_path)

df <- df %>%
  mutate(date = as.Date(paste(year, month, "01", sep = "-"), format = "%Y-%m-%d"))

selected_companies <- c("Y002-YNGTC")  

df_filtered <- df %>%
  filter(customer %in% selected_companies)

scale_factor <- max(df_filtered$total_earned, na.rm = TRUE) / max(df_filtered$time_in_hr, na.rm = TRUE)

df_filtered <- df_filtered %>%
  mutate(time_in_hr_scaled = time_in_hr * scale_factor)  

# Create a dual-axis line chart with full number formatting
p <- ggplot(df_filtered, aes(x = date)) +
  geom_line(aes(y = total_earned, color = "Total Earning ($)"), size = 1) +  # Left Y-axis
  geom_line(aes(y = time_in_hr_scaled, color = "Time in Hours"), size = 1, linetype = "dashed") +  # Right Y-axis
  scale_y_continuous(
    name = "Total Earning ($)",  # Left Y-axis label
    labels = scales::comma,  # Format numbers with full comma-separated values
    sec.axis = sec_axis(~ . / scale_factor, name = "Time Spent (Hours)")
  ) +
  labs(title = paste("Total Earning and Operation time: Monthly trends for", selected_companies),
       x = "Month/Year",
       color = "Metric") +
  scale_color_manual(values = c("Total Earning ($)" = "blue", "Time in Hours" = "red")) +
  scale_x_date(date_labels = "%Y-%m", date_breaks = "2 months") +  
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Show plot
print(p)


```
```{r}
library(dplyr)
library(ggplot2)
library(readxl)
library(lubridate)
library(scales)  

file_path <- "C:/Users/vetdd/Documents/NSS_project/metalworkingsolutions-pandas/25_03_11/customer_hour_earned.xlsx"
df <- read_excel(file_path)

df <- df %>%
  mutate(date = as.Date(paste(year, month, "01", sep = "-"), format = "%Y-%m-%d"))

selected_companies <- c("M030-MORGO")  

df_filtered <- df %>%
  filter(customer %in% selected_companies)

scale_factor <- max(df_filtered$total_earned, na.rm = TRUE) / max(df_filtered$time_in_hr, na.rm = TRUE)

df_filtered <- df_filtered %>%
  mutate(time_in_hr_scaled = time_in_hr * scale_factor)  

# Create a dual-axis line chart with full number formatting
p <- ggplot(df_filtered, aes(x = date)) +
  geom_line(aes(y = total_earned, color = "Total Earning ($)"), size = 1) +  # Left Y-axis
  geom_line(aes(y = time_in_hr_scaled, color = "Time in Hours"), size = 1, linetype = "dashed") +  # Right Y-axis
  scale_y_continuous(
    name = "Total Earning ($)",  # Left Y-axis label
    labels = scales::comma,  # Format numbers with full comma-separated values
    sec.axis = sec_axis(~ . / scale_factor, name = "Time Spent (Hours)")
  ) +
  labs(title = paste("Total Earning and Operation time: Monthly trends for", selected_companies),
       x = "Month/Year",
       color = "Metric") +
  scale_color_manual(values = c("Total Earning ($)" = "blue", "Time in Hours" = "red")) +
  scale_x_date(date_labels = "%Y-%m", date_breaks = "2 months") +  
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Show plot
print(p)
```
```{r}
library(dplyr)
library(ggplot2)
library(readxl)
library(lubridate)
library(scales)  

file_path <- "C:/Users/vetdd/Documents/NSS_project/metalworkingsolutions-pandas/25_03_11/customer_hour_earned.xlsx"
df <- read_excel(file_path)

df <- df %>%
  mutate(date = as.Date(paste(year, month, "01", sep = "-"), format = "%Y-%m-%d"))

selected_companies <- c("F022-F&D")  

df_filtered <- df %>%
  filter(customer %in% selected_companies)

scale_factor <- max(df_filtered$total_earned, na.rm = TRUE) / max(df_filtered$time_in_hr, na.rm = TRUE)

df_filtered <- df_filtered %>%
  mutate(time_in_hr_scaled = time_in_hr * scale_factor)  

# Create a dual-axis line chart with full number formatting
p <- ggplot(df_filtered, aes(x = date)) +
  geom_line(aes(y = total_earned, color = "Total Earning ($)"), size = 1) +  # Left Y-axis
  geom_line(aes(y = time_in_hr_scaled, color = "Time in Hours"), size = 1, linetype = "dashed") +  # Right Y-axis
  scale_y_continuous(
    name = "Total Earning ($)",  # Left Y-axis label
    labels = scales::comma,  # Format numbers with full comma-separated values
    sec.axis = sec_axis(~ . / scale_factor, name = "Time Spent (Hours)")
  ) +
  labs(title = paste("Total Earning and Operation time: Monthly trends for", selected_companies),
       x = "Month/Year",
       color = "Metric") +
  scale_color_manual(values = c("Total Earning ($)" = "blue", "Time in Hours" = "red")) +
  scale_x_date(date_labels = "%Y-%m", date_breaks = "2 months") +  
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Show plot
print(p)
```
```{r}
library(dplyr)
library(ggplot2)
library(readxl)
library(lubridate)
library(scales)  

file_path <- "C:/Users/vetdd/Documents/NSS_project/metalworkingsolutions-pandas/25_03_11/customer_hour_earned.xlsx"
df <- read_excel(file_path)

df <- df %>%
  mutate(date = as.Date(paste(year, month, "01", sep = "-"), format = "%Y-%m-%d"))

selected_companies <- c("S038-STLKI")  

df_filtered <- df %>%
  filter(customer %in% selected_companies)

scale_factor <- max(df_filtered$total_earned, na.rm = TRUE) / max(df_filtered$time_in_hr, na.rm = TRUE)

df_filtered <- df_filtered %>%
  mutate(time_in_hr_scaled = time_in_hr * scale_factor)  

# Create a dual-axis line chart with full number formatting
p <- ggplot(df_filtered, aes(x = date)) +
  geom_line(aes(y = total_earned, color = "Total Earning ($)"), size = 1) +  # Left Y-axis
  geom_line(aes(y = time_in_hr_scaled, color = "Time in Hours"), size = 1, linetype = "dashed") +  # Right Y-axis
  scale_y_continuous(
    name = "Total Earning ($)",  # Left Y-axis label
    labels = scales::comma,  # Format numbers with full comma-separated values
    sec.axis = sec_axis(~ . / scale_factor, name = "Time Spent (Hours)")
  ) +
  labs(title = paste("Total Earning and Operation time: Monthly trends for", selected_companies),
       x = "Month/Year",
       color = "Metric") +
  scale_color_manual(values = c("Total Earning ($)" = "blue", "Time in Hours" = "red")) +
  scale_x_date(date_labels = "%Y-%m", date_breaks = "2 months") +  
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Show plot
print(p)
```


